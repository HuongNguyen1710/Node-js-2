<h3>Tài khoản của tôi</h3>

<%
  // Bảo vệ: nếu controller không truyền thì vẫn có biến dùng
  const _user = typeof user !== 'undefined' ? user : null;
  const _ordersByStatus =
    (typeof ordersByStatus !== 'undefined' && ordersByStatus)
      ? ordersByStatus
      : { pending: [], processing: [], completed: [], cancelled: [] };

  const provinces = [
    "Hà Nội","Hồ Chí Minh","Hải Phòng","Đà Nẵng","Cần Thơ",
    "An Giang","Bà Rịa - Vũng Tàu","Bắc Giang","Bắc Kạn","Bạc Liêu",
    "Bắc Ninh","Bến Tre","Bình Định","Bình Dương","Bình Phước",
    "Bình Thuận","Cà Mau","Cao Bằng","Đắk Lắk","Đắk Nông",
    "Điện Biên","Đồng Nai","Đồng Tháp","Gia Lai","Hà Giang",
    "Hà Nam","Hà Tĩnh","Hải Dương","Hậu Giang","Hòa Bình",
    "Hưng Yên","Khánh Hòa","Kiên Giang","Kon Tum","Lai Châu",
    "Lâm Đồng","Lạng Sơn","Lào Cai","Long An","Nam Định",
    "Nghệ An","Ninh Bình","Ninh Thuận","Phú Thọ","Phú Yên",
    "Quảng Bình","Quảng Nam","Quảng Ngãi","Quảng Ninh","Quảng Trị",
    "Sóc Trăng","Sơn La","Tây Ninh","Thái Bình","Thái Nguyên",
    "Thanh Hóa","Thừa Thiên Huế","Tiền Giang","Trà Vinh","Tuyên Quang",
    "Vĩnh Long","Vĩnh Phúc","Yên Bái"
  ];

  const selectedProvinceProfile =
    _user && _user.defaultAddress ? (_user.defaultAddress.city || "") : "";
%>

<div class="row">
  <!-- Thông tin cá nhân + form cập nhật -->
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header bg-warning fw-bold">
        Thông tin cá nhân
      </div>
      <div class="card-body">
        <% if (_user) { %>
          <p><strong>Họ tên:</strong> <%= _user.fullName %></p>
          <p><strong>Email:</strong> <%= _user.email || "(chưa có email)" %></p>

          <% if (_user.defaultAddress) { %>
            <p><strong>Số điện thoại:</strong> <%= _user.defaultAddress.phone || "Chưa cập nhật" %></p>
            <p><strong>Địa chỉ:</strong><br>
              <%= _user.defaultAddress.line1 || "" %><br>
              <%= _user.defaultAddress.ward || "" %>,
              <%= _user.defaultAddress.district || "" %>,
              <%= _user.defaultAddress.city || "" %>
            </p>
          <% } else { %>
            <p><em>Chưa có địa chỉ mặc định.</em></p>
          <% } %>
        <% } else { %>
          <p>Không tìm thấy thông tin người dùng.</p>
        <% } %>

        <hr>

        <!-- FORM CẬP NHẬT -->
        <form action="/auth/profile/update" method="post" id="profileUpdateForm">
          <div class="mb-2">
            <label class="form-label">Họ tên</label>
            <input
              type="text"
              name="fullName"
              class="form-control"
              value="<%= _user ? _user.fullName : '' %>"
              required
            >
          </div>

          <div class="mb-2">
            <label class="form-label">Email (không thể thay đổi)</label>
            <input
              type="email"
              class="form-control"
              value="<%= _user ? _user.email : '' %>"
              readonly
            >
          </div>

          <div class="mb-2">
            <label class="form-label">Số điện thoại</label>
            <input
              type="text"
              name="phone"
              class="form-control"
              pattern="0[0-9]{9}"
              inputmode="numeric"
              placeholder="Ví dụ: 0912345678"
              value="<%= _user && _user.defaultAddress ? (_user.defaultAddress.phone || '') : '' %>"
            >
            <div class="form-text">
              Phải bắt đầu bằng 0 và đủ 10 số (giống form đặt hàng).
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Địa chỉ </label>
            <input
              type="text"
              name="line1"
              class="form-control"
              value="<%= _user && _user.defaultAddress ? (_user.defaultAddress.line1 || '') : '' %>"
              placeholder="Số nhà, đường..."
            >
          </div>

          <!-- Tỉnh / Thành phố -->
          <div class="mb-2">
            <label class="form-label">Tỉnh / Thành phố</label>
            <select
              name="city"
              id="profileProvinceSelect"
              class="form-select profile-select-location"
              required
            >
              <option value="">-- Chọn tỉnh/thành phố --</option>
              <% provinces.forEach(function (p) { %>
                <option value="<%= p %>" <%= selectedProvinceProfile === p ? "selected" : "" %>><%= p %></option>
              <% }) %>
            </select>
          </div>

          <!-- Quận / Huyện -->
          <div class="mb-2">
            <label class="form-label">Quận / Huyện</label>
            <select
              name="district"
              id="profileDistrictSelect"
              class="form-select profile-select-location"
              required
            >
              <option value="<%= _user && _user.defaultAddress ? (_user.defaultAddress.district || '') : '' %>">
                <%= _user && _user.defaultAddress && _user.defaultAddress.district
                      ? _user.defaultAddress.district
                      : "-- Chọn quận/huyện --" %>
              </option>
            </select>
          </div>

          <!-- Phường / Xã -->
          <div class="mb-2">
            <label class="form-label">Phường / Xã</label>
            <select
              name="ward"
              id="profileWardSelect"
              class="form-select profile-select-location"
              required
            >
              <option value="<%= _user && _user.defaultAddress ? (_user.defaultAddress.ward || '') : '' %>">
                <%= _user && _user.defaultAddress && _user.defaultAddress.ward
                      ? _user.defaultAddress.ward
                      : "-- Chọn phường/xã --" %>
              </option>
            </select>
          </div>

          <button type="submit" class="btn btn-sm btn-primary mt-2">
            Lưu thay đổi
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Đơn hàng -->
  <div class="col-md-8">
    <div class="card">
      <div class="card-header bg-light">
        <ul class="nav nav-tabs card-header-tabs" id="orderTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab"
                    data-bs-target="#pending" type="button" role="tab">
              Đang chờ xử lý (<%= _ordersByStatus.pending.length %>)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="processing-tab" data-bs-toggle="tab"
                    data-bs-target="#processing" type="button" role="tab">
              Đang giao / xử lý (<%= _ordersByStatus.processing.length %>)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab"
                    data-bs-target="#completed" type="button" role="tab">
              Đã hoàn thành (<%= _ordersByStatus.completed.length %>)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab"
                    data-bs-target="#cancelled" type="button" role="tab">
              Đã hủy (<%= _ordersByStatus.cancelled.length %>)
            </button>
          </li>
        </ul>
      </div>

      <div class="card-body tab-content">
        <!-- Đơn chờ xử lý -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
          <% if (!_ordersByStatus.pending.length) { %>
            <p>Không có đơn hàng nào đang chờ xử lý.</p>
          <% } else { %>
            <%- include("../order/_orders-table", { orders: _ordersByStatus.pending }) %>
          <% } %>
        </div>

        <!-- Đang giao / xử lý -->
        <div class="tab-pane fade" id="processing" role="tabpanel">
          <% if (!_ordersByStatus.processing.length) { %>
            <p>Không có đơn hàng nào đang giao.</p>
          <% } else { %>
            <%- include("../order/_orders-table", { orders: _ordersByStatus.processing }) %>
          <% } %>
        </div>

        <!-- Đã hoàn thành -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
          <% if (!_ordersByStatus.completed.length) { %>
            <p>Chưa có đơn hàng nào hoàn thành.</p>
          <% } else { %>
            <%- include("../order/_orders-table", { orders: _ordersByStatus.completed }) %>
          <% } %>
        </div>

        <!-- Đã hủy -->
        <div class="tab-pane fade" id="cancelled" role="tabpanel">
          <% if (!_ordersByStatus.cancelled.length) { %>
            <p>Không có đơn hàng nào bị hủy.</p>
          <% } else { %>
            <%- include("../order/_orders-table", { orders: _ordersByStatus.cancelled }) %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Select2 cho dropdown địa chỉ (giống checkout) -->
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(function () {
    const VN_DATA = {
      "Hà Nội": {
        "Quận Ba Đình": [
          "Phường Điện Biên",
          "Phường Kim Mã",
          "Phường Thành Công",
          "Phường Ngọc Hà"
        ],
        "Quận Hoàn Kiếm": [
          "Phường Hàng Bạc",
          "Phường Hàng Bồ",
          "Phường Hàng Đào",
          "Phường Tràng Tiền"
        ]
      },
      "Hồ Chí Minh": {
        "Quận 1": [
          "Phường Bến Nghé",
          "Phường Bến Thành",
          "Phường Cô Giang",
          "Phường Nguyễn Cư Trinh"
        ],
        "Quận Bình Thạnh": [
          "Phường 1",
          "Phường 5",
          "Phường 11",
          "Phường 17"
        ]
      },
      "Tiền Giang": {
        "Cái Bè": [
          "Xã An Thái Đông",
          "Xã An Thái Trung",
          "Xã Mỹ Lợi",
          "Xã An Hữu"
        ]
      }
      // ... nếu muốn, copy thêm data giống file checkout
    };

    const oldProvince = "<%= selectedProvinceProfile || '' %>".trim();
    const oldDistrict = "<%= _user && _user.defaultAddress ? (_user.defaultAddress.district || '') : '' %>".trim();
    const oldWard = "<%= _user && _user.defaultAddress ? (_user.defaultAddress.ward || '') : '' %>".trim();

    const $province = $("#profileProvinceSelect");
    const $district = $("#profileDistrictSelect");
    const $ward = $("#profileWardSelect");

    function fillDistricts(province, selectedDistrict) {
      $district.empty();
      $ward.empty();

      if (!province || !VN_DATA[province]) {
        $district.append($('<option>', { value: "", text: "-- Chọn quận/huyện --" }));
        $ward.append($('<option>', { value: "", text: "-- Chọn phường/xã --" }));
        $district.trigger("change.select2");
        $ward.trigger("change.select2");
        return;
      }

      $district.append($('<option>', { value: "", text: "-- Chọn quận/huyện --" }));
      Object.keys(VN_DATA[province]).forEach(d => {
        $district.append($('<option>', { value: d, text: d }));
      });

      if (selectedDistrict && VN_DATA[province][selectedDistrict]) {
        $district.val(selectedDistrict);
      }
      $district.trigger("change.select2");

      fillWards(province, $district.val(), oldWard);
    }

    function fillWards(province, district, selectedWard) {
      $ward.empty();

      if (!province || !district || !VN_DATA[province] || !VN_DATA[province][district]) {
        $ward.append($('<option>', { value: "", text: "-- Chọn phường/xã --" }));
        $ward.trigger("change.select2");
        return;
      }

      $ward.append($('<option>', { value: "", text: "-- Chọn phường/xã --" }));
      VN_DATA[province][district].forEach(w => {
        $ward.append($('<option>', { value: w, text: w }));
      });

      if (selectedWard && VN_DATA[province][district].includes(selectedWard)) {
        $ward.val(selectedWard);
      }
      $ward.trigger("change.select2");
    }

    $('.profile-select-location').select2({
      width: '100%',
      placeholder: 'Chọn...',
      allowClear: true
    });

    $province.on("change", function () {
      fillDistricts($(this).val(), "");
    });

    $district.on("change", function () {
      fillWards($province.val(), $(this).val(), "");
    });

    // load lại dữ liệu cũ nếu có
    if (oldProvince && VN_DATA[oldProvince]) {
      $province.val(oldProvince).trigger("change");
      fillDistricts(oldProvince, oldDistrict);
      fillWards(oldProvince, oldDistrict, oldWard);
    }
  });
</script>
