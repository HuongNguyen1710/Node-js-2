<h3 class="mb-3"><%= title || "Danh sách sản phẩm" %></h3>

<form class="row g-2 mb-3" method="get">
  <div class="col-md-3">
    <input
      type="text"
      name="q"
      class="form-control"
      placeholder="Tìm theo tên"
      value="<%= (query && query.q) || '' %>"
    >
  </div>

  <!-- Thương hiệu: chỉ còn Apple -->
  <div class="col-md-2">
    <select name="brand" class="form-select">
      <option value="">Thương hiệu (Apple)</option>
      <option value="Apple" <%= query && query.brand === 'Apple' ? 'selected' : '' %>>
        Apple
      </option>
    </select>
  </div>

  <div class="col-md-2">
    <select name="minRating" class="form-select">
      <option value="">Đánh giá tối thiểu</option>
      <option value="3" <%= query && query.minRating === '3' ? 'selected' : '' %>>
        Từ 3 sao
      </option>
      <option value="4" <%= query && query.minRating === '4' ? 'selected' : '' %>>
        Từ 4 sao
      </option>
    </select>
  </div>

  <div class="col-md-2">
    <select name="sort" class="form-select">
      <option value="">Sắp xếp</option>
      <option value="name_asc"  <%= query && query.sort === 'name_asc'  ? 'selected' : '' %>>
        Tên A–Z
      </option>
      <option value="name_desc" <%= query && query.sort === 'name_desc' ? 'selected' : '' %>>
        Tên Z–A
      </option>
      <option value="price_asc" <%= query && query.sort === 'price_asc' ? 'selected' : '' %>>
        Giá tăng dần
      </option>
      <option value="price_desc" <%= query && query.sort === 'price_desc' ? 'selected' : '' %>>
        Giá giảm dần
      </option>
    </select>
  </div>

  <div class="col-md-2">
    <button class="btn btn-primary w-100">Lọc</button>
  </div>
</form>

<div class="row">
  <% if (!products || products.length === 0) { %>
    <p>Không có sản phẩm nào.</p>
  <% } %>

  <% products.forEach(function (p) {
       const firstVariant = (p.variants && p.variants.length > 0) ? p.variants[0] : null;
  %>
    <div class="col-md-3 mb-4">
      <div class="card h-100">
        <a href="/products/<%= p._id %>">
          <img src="<%= p.thumbnail %>" class="card-img-top" alt="<%= p.name %>">
        </a>
        <div class="card-body d-flex flex-column">
          <h6 class="card-title">
            <a href="/products/<%= p._id %>" class="text-decoration-none text-dark">
              <%= p.name %>
            </a>
          </h6>

          <p class="mb-1 fw-bold text-danger">
            <%= p.basePrice.toLocaleString("vi-VN") %>₫
          </p>

          <p class="small mb-1">
            ⭐ <%= (p.ratingAverage || 0).toFixed(1) %> / 5 (
            <%= p.ratingCount || 0 %> đánh giá)
          </p>

          <div class="mt-auto d-flex flex-column gap-1">
            <a href="/products/<%= p._id %>" class="btn btn-sm btn-outline-primary w-100">
              Xem chi tiết
            </a>

            <% if (firstVariant) { %>
              <!-- Nút thêm vào giỏ: dùng JS, không form -->
              <button
                type="button"
                class="btn btn-sm btn-warning w-100 btn-add-to-cart"
                data-product-id="<%= p._id %>"
                data-variant-id="<%= firstVariant._id %>"
                data-qty="1"
                js-add-to-cart-form
              >
                Thêm vào giỏ
              </button>
            <% } else { %>
              <button class="btn btn-sm btn-secondary w-100" disabled>
                Hết hàng
              </button>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  <% }) %>
</div>

<nav aria-label="Page navigation">
  <ul class="pagination">
    <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a
          class="page-link"
          href="?<%= new URLSearchParams(Object.assign({}, query, { page: i })).toString() %>"
        >
          <%= i %>
        </a>
      </li>
    <% } %>
  </ul>
</nav>
